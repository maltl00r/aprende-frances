<script src="js/progress.js"></script>
<script>
  async function loadCourse() {
    try {
      const response = await fetch('course.json');
      if (!response.ok) {
          throw new Error('No se pudo cargar el archivo course.json');
      }
      const course = await response.json();
      return course;
    } catch (error) {
      console.error("Error al cargar el curso:", error);
      return null;
    }
  }
  const params = new URLSearchParams(window.location.search);
  const modId = params.get('id');

  const title = document.getElementById('moduleTitle');
  const grid = document.getElementById('flashcardsGrid');
  const toggleBtn = document.getElementById('toggleModuleBtn');

  function speak(text){
    const s = new SpeechSynthesisUtterance(text);
    s.lang = 'fr-FR';
    window.speechSynthesis.speak(s);
  }

  function makeCard(card) {
    const btn = document.createElement('button');
    btn.className = 'flashcard-card';
    btn.setAttribute('role', 'button');
    btn.setAttribute('aria-label', `Flashcard para ${card.fr}`);
    btn.dataset.state = 'word';

    function renderWord(){ btn.innerHTML = `<span class="icon">${card.icon ?? '💡'}</span><p>${card.fr}</p>`; }
    function renderPron(){ btn.innerHTML = `<span class="pronunciation">${card.pron}</span>`; }

    const toggle = () => {
      if(btn.dataset.state === 'word'){ renderPron(); btn.dataset.state = 'pron'; }
      else { renderWord(); btn.dataset.state = 'word'; }
      speak(card.fr);
    };

    btn.addEventListener('click', toggle);
    btn.addEventListener('keydown', e => {
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
    });

    renderWord();
    return btn;
  }

  function renderModule(module){
    if(!module){
      title.textContent = 'Módulo no encontrado';
      toggleBtn.style.display = 'none';
      return;
    }

    title.textContent = module.name;
    grid.innerHTML = '';
    (module.items || []).forEach(card => grid.appendChild(makeCard(card)));

    const state = Progress.getModuleState(module.id);
    if(state?.completed){
      toggleBtn.textContent = 'Módulo completado ✔️';
    } else {
      toggleBtn.textContent = 'Marcar módulo como completado';
    }
  }

  toggleBtn.addEventListener('click', () => {
    if(!module) return;
    const state = Progress.getModuleState(module.id);
    if(state?.completed){
      Progress.resetModule(module.id);
      alert('¡Módulo desmarcado!');
    } else {
      Progress.markCompleted(module.id);
      alert('¡Módulo completado!');
    }
    renderModule(module);
  });

  loadCourse().then(course => {
    if (course) {
      const module = course.modules.find(m => m.id === modId && m.type === 'flashcards');
      renderModule(module);
    }
  });
</script>
</body>
</html>