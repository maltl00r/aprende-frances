<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exámenes - Idiomas A1-A2</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="site-header">
    <h1>Exámenes</h1>
    <nav class="top-nav">
      <a href="index.html">Inicio</a>
    </nav>
  </header>

  <main class="wrap">
    <section>
      <h2 id="quizTitle">Examen</h2>
      <div id="quizContainer" class="quiz-container"></div>
      <div class="actions">
        <button id="submitBtn" class="btn-complete">Enviar examen</button>
        <button id="resetBtn" class="btn-reset">Reiniciar</button>
      </div>
      <p id="quizResult" class="quiz-result"></p>
      <div id="feedbackContainer"></div>
    </section>
  </main>

  <footer class="site-footer">
    <small>Aprende paso a paso. ¡Ánimo!</small>
  </footer>

  <script src="js/progress.js"></script>
  <script>
    async function loadCourse() {
      try {
        const currentLang = new URLSearchParams(window.location.search).get('lang') || 'fr';
        const response = await fetch(`course_${currentLang}.json`);
        if (!response.ok) {
            throw new Error(`No se pudo cargar el archivo course_${currentLang}.json`);
        }
        const course = await response.json();
        return course;
      } catch (error) {
        console.error("Error al cargar el curso:", error);
        return null;
      }
    }

    const params = new URLSearchParams(window.location.search);
    const modId = params.get('id');

    const title = document.getElementById('quizTitle');
    const container = document.getElementById('quizContainer');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const result = document.getElementById('quizResult');
    const feedbackContainer = document.getElementById('feedbackContainer');
    let module;

    function renderModule(quizModule, course) {
      if (!quizModule || quizModule.type !== 'quiz') {
        title.textContent = 'Módulo no encontrado o no es un examen';
        submitBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        return;
      }

      module = quizModule;
      title.textContent = module.name;
      document.title = `${module.name} - ${course.title}`;
      container.innerHTML = '';
      feedbackContainer.innerHTML = '';

      if ((module.questions || []).length === 0) {
        container.innerHTML = '<p>Este examen aún no tiene preguntas.</p>';
        submitBtn.style.display = 'none';
        return;
      }

      (module.questions || []).forEach((q, idx) => {
        const fieldset = document.createElement('fieldset');
        fieldset.className = 'quiz-question';
        const legend = document.createElement('legend');
        legend.textContent = `${idx + 1}. ${q.question}`;
        fieldset.appendChild(legend);

        (q.options || []).forEach((opt, optIdx) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'option-item';
          wrapper.innerHTML = `
            <input type="radio" id="q${idx}opt${optIdx}" name="q${idx}" value="${optIdx}">
            <label for="q${idx}opt${optIdx}">${opt}</label>
          `;
          fieldset.appendChild(wrapper);
        });
        container.appendChild(fieldset);
      });
      submitBtn.style.display = 'block';
    }

    function checkQuiz() {
      let correct = 0;
      feedbackContainer.innerHTML = '';
      const questions = module.questions || [];

      questions.forEach((q, idx) => {
        const chosen = document.querySelector(`input[name="q${idx}"]:checked`);
        const isCorrect = chosen && Number(chosen.value) === q.answer;
        if (isCorrect) {
            correct++;
        } else {
            const feedbackEl = document.createElement('p');
            feedbackEl.className = 'quiz-feedback incorrect';
            feedbackEl.innerHTML = `❌ La respuesta correcta para la pregunta ${idx + 1} era: <strong>${q.options[q.answer]}</strong>`;
            feedbackContainer.appendChild(feedbackEl);
        }
      });

      const score = Math.round((correct / (questions.length || 1)) * 100);
      const passed = score >= (module.pass ?? 60);

      result.textContent = `Puntuación: ${score}% (${correct}/${questions.length})`;

      Progress.setScore(module.id, score);
      if (passed) {
          Progress.markCompleted(module.id);
          result.textContent += ' — ¡Aprobado! ✅';
      } else {
          result.textContent += ' — No aprobado. Inténtalo de nuevo.';
      }
      submitBtn.disabled = true;
    }

    submitBtn.addEventListener('click', checkQuiz);

    resetBtn.addEventListener('click', () => {
      if(!module) return;
      Progress.resetModule(module.id);
      location.reload();
    });

    document.addEventListener('DOMContentLoaded', () => {
      if (!modId) {
        title.textContent = 'Error: ID de módulo no especificado.';
        submitBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        return;
      }
      loadCourse().then(course => {
        if (course) {
          const currentModule = course.modules.find(mod => mod.id === modId);
          renderModule(currentModule, course);
        }
      });
    });
  </script>
</body>
</html>