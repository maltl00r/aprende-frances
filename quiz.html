<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exámenes - Francés A1-A2</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="site-header">
    <h1>Exámenes</h1>
    <nav class="top-nav">
      <a href="index.html">Inicio</a>
    </nav>
  </header>

  <main class="wrap">
    <section>
      <h2 id="quizTitle">Examen</h2>
      <div id="quizContainer" class="quiz-container"></div>
      <div class="actions">
        <button id="submitBtn" class="btn-complete">Enviar examen</button>
        <button id="resetBtn" class="btn-reset">Reiniciar</button>
      </div>
      <p id="quizResult" class="quiz-result"></p>
      <div id="feedbackContainer"></div>
    </section>
  </main>

  <footer class="site-footer">
    <small>Aprende paso a paso. ¡Ánimo!</small>
  </footer>

  <script src="js/progress.js"></script>
  <script>
    async function loadCourse() {
      try {
        const response = await fetch('course.json');
        if (!response.ok) {
            throw new Error('No se pudo cargar el archivo course.json');
        }
        const course = await response.json();
        return course;
      } catch (error) {
        console.error("Error al cargar el curso:", error);
        return null;
      }
    }
    const params = new URLSearchParams(window.location.search);
    const modId = params.get('id');

    const title = document.getElementById('quizTitle');
    const container = document.getElementById('quizContainer');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const result = document.getElementById('quizResult');

    function renderModule(module) {
      if(!module){
        title.textContent = 'Módulo no encontrado';
        submitBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        return;
      }
      title.textContent = module.name;
      container.innerHTML = '';
      (module.questions || []).forEach((q, idx) => {
          const fieldset = document.createElement('fieldset');
          const legend = document.createElement('legend');
          legend.textContent = q.question;
          fieldset.appendChild(legend);
          (q.options || []).forEach((opt, optIdx) => {
              const wrapper = document.createElement('div');
              wrapper.className = 'option-item';
              wrapper.innerHTML = `
                  <input type="radio" name="q${idx}" id="q${idx}o${optIdx}" value="${optIdx}">
                  <label for="q${idx}o${optIdx}">${opt}</label>
              `;
              fieldset.appendChild(wrapper);
          });
          container.appendChild(fieldset);
      });
      const state = Progress.getModuleState(module.id);
      if(state?.completed){
        submitBtn.disabled = true;
        result.textContent = 'Módulo completado ✔️';
      }
    }

    submitBtn.addEventListener('click', () => {
      if (!module) return;
      const state = Progress.getModuleState(module.id);
      if (state?.completed) {
          alert('Ya enviaste este examen.');
          return;
      }

      const feedbackContainer = document.getElementById('feedbackContainer');
      feedbackContainer.innerHTML = '';
      let correct = 0;

      (module.questions || []).forEach((q, idx) => {
          const chosen = document.querySelector(`input[name="q${idx}"]:checked`);
          const isCorrect = chosen && Number(chosen.value) === q.answer;
          if (isCorrect) {
              correct++;
          } else {
              const feedbackEl = document.createElement('p');
              feedbackEl.className = 'quiz-feedback';
              feedbackEl.innerHTML = `❌ La respuesta correcta para "${q.question}" era: <strong>${q.options[q.answer]}</strong>`;
              feedbackContainer.appendChild(feedbackEl);
          }
      });

      const score = Math.round((correct / (module.questions?.length || 1)) * 100);
      const passed = score >= (module.pass ?? 60);

      result.textContent = `Puntuación: ${score}% (${correct}/${module.questions.length})`;

      Progress.setScore(module.id, score);
      if (passed) {
          Progress.markCompleted(module.id);
          result.textContent += ' — ¡Aprobado! ✅';
      } else {
          result.textContent += ' — No aprobado. Inténtalo de nuevo.';
      }

      submitBtn.disabled = true;
    });

    resetBtn.addEventListener('click', () => {
      if(!module) return;
      Progress.resetModule(module.id);
      alert('Progreso reiniciado. Puedes volver a intentar el examen.');
      location.reload();
    });

    loadCourse().then(course => {
      if (course) {
        const module = course.modules.find(m => m.id === modId && m.type === 'quiz');
        renderModule(module);
      }
    });
  </script>
</body>
</html>